---
title: "Getting your toes wet in R: Hydrology, meteorology, and more"
author: "Sam Albers, Ilaria Prosdocimi and Sam Zipper, "
date: "18/02/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importance of Hydrology
Given that liquid water is [essential to life on Earth](https://www.amnh.org/explore/science-topics/water-and-life-on-earth), water research cuts across numerous disciplines including hydrology, meteorology, geography, climate science, engineering, ecology, and more. Numerous R packages have emerged from this diversity of approaches, and we recently gathered many of these packages into a new [task view](https://github.com/ropensci/Hydrology) which we broadly titled 'hydrology' and posted to [CRAN](https://CRAN.R-project.org/view=Hydrology). Our intent is to be exhaustive and compile R packages to access, model, and summarise information related to the movement of water across the Earth's landscape. We hope to contribute to a [nascent community of hydrological R users](https://www.hydrol-earth-syst-sci-discuss.net/hess-2019-50/) and develop an infrastructure of packages that provide a comprehensive toolkit for water practitioners who use R as their preferred computational analysis tool. Making sense of water data is critical to understanding the response of landscapes to climate change. Consolidating water-related packages will promote their usage and discovery and ultimately facilitate reproducible workflows for water research. Since this is a new task view, it serves our purpose to evaluate the current State of Hydrology in R and look at the interdependency of hydrology packages against some better known collections of packages in the general R ecosystem. 

## State of Hydrology in R
We will conduct a high-level assessment of the state of hydrology in R by visualizing network connectivity among package dependencies -- which packages use code from one package to accomplish a task. For context, we will evaluate our Hydrology task view against the most well-known collection of packages in R, the [tidyverse](https://www.tidyverse.org/), and the venerable [Environmetrics task view](https://CRAN.R-project.org/view=Environmetrics
) which includes many packages for environmental Analysis. To do that we need write some R code:

![](https://media.giphy.com/media/xT8qBmSnYDXS21ZvHO/giphy.gif)

 and load our required packages

```{r}
suppressPackageStartupMessages(library(tidyverse))
library(tidygraph, warn.conflicts = FALSE)
library(ggraph)
library(ctv)
```

We will use the handy `CRAN_package_db` function from the `tools` package (part of base R) which conveniently grabs information from the DESCRIPTION file of every package and turns it into a dataframe. Here we are only after a few columns so we will extract those right away:
```{r, cache=TRUE}
all_cran_packages <- tools::CRAN_package_db()[,c("Package", "Imports", "Packaged")] 
```

We are also going to parse some of the info we receive from CRAN to make it a little easier to work with:
```{r}
tidied_cran_imports <- all_cran_packages %>% 
  as_tibble() %>% 
  mutate(Imports = stringr::str_split(Imports, ",")) %>% 
  unnest(Imports) %>% 
  mutate(Imports = str_replace(Imports,"\\(.*?\\)|\n","") ) %>%
  mutate(Imports = str_trim(Imports, side = "both")) %>%  
  mutate(Packaged = str_replace(Packaged, ";.*","")) %>%
  #mutate(Packaged = str_replace(Packaged, " UTC","")) %>%
  mutate(Packaged = format(as.Date(Packaged), "%Y"))
```

First, let's take a look at the tidyverse. We can take the rare step of actually using a function from the tidyverse package (`tidyverse_packages`), which identifies those packages actually belonging to the tidyverse. We filter for those packages and then convert to the `tbl_graph` which is then easily plotted using `ggraph`:
```{r}
tidyverse_tbl <- tidied_cran_imports %>% 
  select(-Packaged) %>% 
  filter(Package %in% tidyverse_packages()) %>% 
  filter(Imports %in% tidyverse_packages()) %>% 
  as_tbl_graph() 

ggraph(tidyverse_tbl, layout = 'nicely') + 
  geom_edge_link() + 
  geom_node_point() +
  geom_node_label(aes(label = name), repel = TRUE, colour = "blue") +
  theme_minimal()
```

As you might expect, we see many intersecting lines traversing in all directions. Many packages in the tidyverse import other packages in the tidyverse. This is expected as the tidyverse is developed in a coordinated manner. 

Next, let's have a look at the Environmetrics task view where we might not expect to see the same degree of connectivity. The `ctv` package provides us with the vector of package names for a given task view, which we can use to similarly create a network plot:

```{r}
env_packages <- ctv:::.get_pkgs_from_ctv_or_repos(views = "Environmetrics", 
                                                           coreOnly = FALSE, 
                                                           repos = NULL) %>% 
  unlist(use.names = FALSE)

env_tbl <- tidied_cran_imports %>% 
  select(-Packaged) %>% 
  filter(Package %in% env_packages) %>% 
  filter(Imports %in% env_packages) %>% 
  as_tbl_graph() 

ggraph(env_tbl, layout = 'nicely') + 
  geom_edge_link() + 
  geom_node_point() +
  geom_node_label(aes(label = name), repel = TRUE, colour = "blue") +
  theme_minimal()
```

While there are clearly fewer connections than in the tidyverse package ecosystem, there is still quite a large amount of connectivity in Environmetrics task view In particular the `mgcv`, `MASS`, `vegan` and `zoo` packages all provide critical infrastructure for those developing packages in this field. This presumably can at least partially be attributed to the age of the Environmetrics package. 

Finally, we can evaluate the new Hydrology task view:

```{r}
hyd_packages <- ctv:::.get_pkgs_from_ctv_or_repos(views = "Hydrology", 
                                                           coreOnly = FALSE, 
                                                           repos = NULL) %>% 
  unlist(use.names = FALSE)

hyd_tbl <- tidied_cran_imports %>% 
  select(-Packaged) %>% 
  filter(Package %in% hyd_packages) %>% 
  filter(Imports %in% hyd_packages) %>% 
  as_tbl_graph() 

ggraph(hyd_tbl, layout = 'nicely') + 
  geom_edge_link() + 
  geom_node_point() +
  geom_node_label(aes(label = name), repel = TRUE, colour = "blue") +
  theme_minimal()

```

Clearly, some connectivity among water-related packages is already happening, which serves as a reminder that CRAN task views aren't the only place people discover packages to use. However, if the Hydrology CRAN task view can enhance this connectivity, developers and hydrologist can leverage the efforts of others in the hydrology space. A topic in R can live in many places without detracting from others. Twitter, Stack OverFlow and GitHub are all obviously great places to strengthen the community of water practitioners using R. Our task view hopefully will join those spaces as a tool to enable shared efforts towards water management. You can contribute to the task view by opening an issue or pull request at out [project repo](https://github.com/ropensci/Hydrology).


## Future of R for Hydrology

Hydrology, like many other sciences, is becoming more and more data driven and programmatic ways to access, manipulate and model data in a reproducible workflow are becoming a necessity. 
Water related data though has its own specific challenges, which are similar but different from those of other data sources. 
<!-- The Hydrology Task Force aims to be the unique point where R users interested in analysiing water data can find information on what tools are currently available to them.  -->
It can expected that with a growing uptake of R in the hydrological community more packages will be available, with more interconnectivity between them. 
At the moment the landscape of R for hydrologists is quite fragmented, but in time it might be that some `core' packages to manipulate data will emerge and several computational approaches to hydrological models will be centralised in a unique package. 
Regardless of how the landscape of hydrology packages will evolve, R and open source tools are becoming more and more important in the hydrological community, and we are happy to have made a small contribution to make it easier for everybody to know what can already be done with water data in R. 


